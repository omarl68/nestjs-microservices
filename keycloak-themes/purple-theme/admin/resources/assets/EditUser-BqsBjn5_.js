import{jsx as e,jsxs as k,Fragment as j}from"react/jsx-runtime";import{useState as P,useMemo as et,useRef as pt,Fragment as ht}from"react";import{cj as tt,ck as ft,cl as gt,co as He,cn as bt,cm as yt,c3 as wt,ci as Ct,c4 as vt,e7 as It,e8 as kt,cO as Pt,e9 as Tt,ea as Dt,eb as Lt,Z as rt,P as pe,bU as Se,u as N,e as $,B as de,f as g,A as B,ar as G,a6 as At,a7 as Rt,p as xt,h as U,O as St,ct as Ut,aq as Et,D as Ue,g as Ce,a0 as oe,cd as Ft,aC as Nt,a1 as Be,a3 as at,a4 as Mt,F as st,ec as Bt,a2 as V,V as Kt,q as Ee,U as nt,ad as Ot,aQ as We,af as Gt,aR as it,bz as Vt,X as qt,bV as jt,b as Ke,a as Ht,ba as _e,Y as ke,G as Pe,br as Wt,L as _t,bZ as zt,n as Fe,d0 as $t,c as Qt,dk as Xt,K as Yt,bd as Jt,be as Zt,e3 as er,e4 as ze}from"./index-C9t2UlUN.js";import{u as he,C as ot}from"./ConfirmDialog-BDkqxnFL.js";import{R as tr,u as rr}from"./RoutableTabs-vx5wTdby.js";import{V as ar}from"./ViewHeader-cxZm8XhN.js";import{U as sr}from"./UserProfileContext-BGkDcTK6.js";import{u as Oe}from"./useParams-DL8-63Ov.js";import{A as nr}from"./AttributeForm-CF8uy5gF.js";import{a as Ne,R as ir,F as or,U as dr,t as lr,f as cr}from"./UserForm-BB1TTnrw.js";import{U as mr}from"./userProfileMetadata-CFgHgJ2w.js";import{i as ur,l as $e,L as Ge}from"./PaginatingTableToolbar-oQUfBy2J.js";import{a1 as De,a2 as F,ac as pr,ad as hr,ae as fr,af as gr,a8 as S,a0 as br,a3 as Qe,a4 as Xe,a5 as ye,a6 as q,a7 as Ye,aa as xe}from"./KeycloakDataTable-2rLFZPhG.js";import{u as dt}from"./useFormatDate-Yp0qEhJS.js";import{s as lt}from"./sortBy-CgAHVq9r.js";import{C as yr,S as wr,i as Cr}from"./SessionsTable-BPkwHML9.js";import{u as Me}from"./useToggle-K3Kx99tM.js";import{M as ct,a as Ve}from"./Modal-Bgkd26UL.js";import{K as Te}from"./KeycloakTextInput-DrlF32nr.js";import{F as Le}from"./Form-Cdw1qhWG.js";import{T as vr}from"./TimeSelector-CWH4kuIN.js";import{P as Je}from"./PasswordInput-CJKuHljf.js";import{G as Ir,b as kr}from"./GroupPickerDialog-tI6XV7Ln.js";import{b as Pr}from"./_baseFlatten-BQ8y46Zj.js";import{Q as Tr}from"./question-circle-icon-B-vzDm0d.js";import{c as we}from"./capitalize-w6Zchk1l.js";import{R as Dr}from"./AddRoleMappingModal-BWNuJU0W.js";/* empty css                     */import{a as ne,b as ie}from"./Tabs-CjrDEqsl.js";import"react-dom";import"./PageHandler-TK8xnd8P.js";import"./DynamicComponents-D5DD9CFr.js";import"./FileUpload-CTw4RKK1.js";import"./CodeEditor-Cp4g17EF.js";import"./copy-icon-CYSS18Ce.js";import"./EmptyStateBody-CyIhnUop.js";import"./EmptyStateSecondaryActions-BekVwNvY.js";import"./FlexItem-BEayPdRt.js";import"./KeySelect-CPI9XGq0.js";import"./MultiLineInput-DibC-IV_.js";import"./KeycloakTextArea-DChmurIP.js";import"./PageList-59HC89eh.js";import"./ToolbarContent-D6TJq6fk.js";import"./grip-vertical-icon-B_ub3hpF.js";import"./FormAccess-DnQCcStE.js";import"./KeyValueInput-BJlDoGlu.js";import"./ListItem-B-msUVzK.js";import"./DataListItemRow-Bimi62Tu.js";import"./_baseSlice-F8doVSIJ.js";import"./filter-icon-C8nM2k1N.js";import"./MenuList-Br-Zu33q.js";var Lr=Math.min;function Ar(t,s,r){for(var u=r?bt:yt,l=t[0].length,o=t.length,c=o,p=Array(o),m=1/0,h=[];c--;){var d=t[c];c&&s&&(d=tt(d,ft(s))),m=Lr(d.length,m),p[c]=!r&&(s||l>=120&&d.length>=120)?new gt(c&&d):void 0}d=t[0];var i=-1,D=p[0];e:for(;++i<l&&h.length<m;){var b=d[i],y=s?s(b):b;if(b=r||b!==0?b:0,!(D?He(D,y):u(h,y,r))){for(c=o;--c;){var w=p[c];if(!(w?He(w,y):u(t[c],y,r)))continue e}D&&D.push(y),h.push(b)}}return h}function Rr(t){return ur(t)?t:[]}var xr=Pr(function(t){var s=$e(t),r=tt(t,Rr);return s===$e(r)?s=void 0:r.pop(),r.length&&r[0]===t[0]?Ar(r,wt(s)):[]}),Sr="[object Map]",Ur="[object Set]",Er=Object.prototype,Fr=Er.hasOwnProperty;function Ze(t){if(t==null)return!0;if(Ct(t)&&(vt(t)||typeof t=="string"||typeof t.splice=="function"||It(t)||kt(t)||Pt(t)))return!t.length;var s=Tt(t);if(s==Sr||s==Ur)return!t.size;if(Dt(t))return!Lt(t).length;for(var r in t)if(Fr.call(t,r))return!1;return!0}const Nr=({user:t,save:s,upConfig:r})=>{const u=rt();return e(pe,{variant:Se.light,children:e(nr,{form:u,save:s,fineGrainedAccess:t.access?.manage,reset:()=>u.reset({...u.getValues(),attributes:Ne(t).attributes}),name:"unmanagedAttributes",isDisabled:mr.AdminView==r?.unmanagedAttributePolicy})})},Mr=()=>{const[t,s]=P(),{t:r}=N(),{addAlert:u,addError:l}=$(),o=dt(),[c,p]=P(0),{id:m}=Oe(),h=w=>lt(w,E=>E.clientId?.toUpperCase()),d=()=>p(new Date().getTime()),i=async()=>{const w=await g.users.listConsents({id:m});return h(w)},D=({grantedClientScopes:w})=>e(At,{className:"kc-consents-chip-group",children:w.map(E=>e(Rt,{isReadOnly:!0,className:"kc-consents-chip",children:E},E))}),[b,y]=he({titleKey:"revokeClientScopesTitle",messageKey:r("revokeClientScopes",{clientId:t?.clientId}),continueButtonLabel:"revoke",continueButtonVariant:de.danger,onConfirm:async()=>{try{await g.users.revokeConsent({id:m,clientId:t.clientId}),d(),u(r("deleteGrantsSuccess"),B.success)}catch(w){l("deleteGrantsError",w)}}});return k(j,{children:[e(y,{}),e(De,{loader:i,ariaLabelKey:"roleList",searchPlaceholderKey:" ",columns:[{name:"clientId",displayKey:"Client",cellFormatters:[G()],transforms:[F(20)]},{name:"grantedClientScopes",displayKey:"grantedClientScopes",cellFormatters:[G()],cellRenderer:D,transforms:[F(30)]},{name:"createDate",displayKey:"created",transforms:[F(20)],cellRenderer:({createDate:w})=>w?o(new Date(w)):"—"},{name:"lastUpdatedDate",displayKey:"lastUpdated",transforms:[F(10)],cellRenderer:({lastUpdatedDate:w})=>w?o(new Date(w)):"—"}],actions:[{title:r("revoke"),onRowClick:w=>{s(w),b()}}],emptyState:e(Ge,{hasIcon:!0,icon:yr,message:r("noConsents"),instructions:r("noConsentsText")})},c)]})},Br=({credentialData:t,onClose:s})=>{const{t:r}=N();return e(ct,{variant:Ve.medium,title:r("passwordDataTitle"),"data-testid":"passwordDataDialog",isOpen:!0,onClose:s,children:k(pr,{"aria-label":r("passwordDataTitle"),"data-testid":"password-data-dialog",variant:hr.compact,cells:[r("showPasswordDataName"),r("showPasswordDataValue")],rows:t,children:[e(fr,{}),e(gr,{})]})})},Kr=({credential:t,resetPassword:s,toggleDelete:r,children:u})=>{const l=dt(),{t:o}=N(),[c,p]=Me(),[m,h]=Me(),d=xt(),i=et(()=>{if(!t.credentialData)return[];const D=JSON.parse(t.credentialData);return d(Object.entries(D),([b])=>b).map(([b,y])=>typeof y=="string"?[b,y]:[b,JSON.stringify(y)])},[t.credentialData]);return k(j,{children:[c&&Object.keys(t).length!==0&&e(Br,{credentialData:i,onClose:()=>{p()}}),e(S,{children:u}),e(S,{children:l(new Date(t.createdDate))}),e(S,{children:e(U,{className:"kc-showData-btn",variant:"link","data-testid":"showDataBtn",onClick:p,children:o("showDataBtn")})}),t.type==="password"?e(S,{isActionCell:!0,children:e(U,{variant:"secondary","data-testid":"resetPasswordBtn",onClick:s,children:o("resetPasswordBtn")})}):e(S,{}),e(S,{isActionCell:!0,children:e(St,{isPlain:!0,position:Ut.right,toggle:e(Et,{onToggle:h}),isOpen:m,dropdownItems:[e(Ue,{"data-testid":"deleteDropdownItem",component:"button",onClick:()=>{r(),h()},children:o("deleteBtn")},t.id)]})})]})},Or=({userId:t,credential:s,isEditable:r,toggle:u})=>{const{t:l}=N(),{register:o,handleSubmit:c}=Ce(),{addAlert:p,addError:m}=$();return e(Le,{isHorizontal:!0,className:"kc-form-userLabel",onSubmit:c(async d=>{try{await g.users.updateCredentialLabel({id:t,credentialId:s.id},d.userLabel||""),p(l("updateCredentialUserLabelSuccess"),B.success),u()}catch(i){m("updateCredentialUserLabelError",i)}}),children:e(oe,{fieldId:"kc-userLabel",className:"kc-userLabel-row",children:e("div",{className:"kc-form-group-userLabel",children:r?k(j,{children:[e(Te,{"data-testid":"userLabelFld",defaultValue:s.userLabel,className:"kc-userLabel","aria-label":l("userLabel"),...o("userLabel")}),k("div",{className:"kc-userLabel-actionBtns",children:[e(U,{"data-testid":"editUserLabelAcceptBtn",variant:"link",className:"kc-editUserLabelAcceptBtn","aria-label":l("acceptBtn"),type:"submit",icon:e(Ft,{})}),e(U,{"data-testid":"editUserLabelCancelBtn",variant:"link",className:"kc-editUserLabel-cancelBtn","aria-label":l("cancelBtn"),onClick:u,icon:e(Nt,{})})]})]}):k(j,{children:[s.userLabel,e(U,{"aria-label":l("editUserLabel"),variant:"link",className:"kc-editUserLabel-btn",onClick:u,"data-testid":"editUserLabelBtn",icon:e(br,{})})]})})})})},Gr=()=>{const{t}=N(),{control:s}=rt();return e(oe,{fieldId:"lifespan",label:t("lifespan"),isStack:!0,labelIcon:e(Be,{helpText:t("lifespanHelp"),fieldLabelId:"lifespan"}),children:e(at,{name:"lifespan",defaultValue:mt.lifespan,control:s,render:({field:r})=>e(vr,{value:r.value,units:["minute","hour","day"],onChange:r.onChange,menuAppendTo:"parent"})})})},mt={actions:[],lifespan:43200},Vr=({userId:t,onClose:s})=>{const{t:r}=N(),u=Ce({defaultValues:mt}),{handleSubmit:l,control:o}=u,c=Mt({control:o,name:"actions"}),p=!Ze(c),{addAlert:m,addError:h}=$(),d=async({actions:i,lifespan:D})=>{if(!Ze(i))try{await g.users.executeActionsEmail({id:t,actions:i,lifespan:D}),m(r("credentialResetEmailSuccess"),B.success),s()}catch(b){h("credentialResetEmailError",b)}};return e(ot,{variant:Ve.medium,titleKey:"credentialReset",open:!0,onCancel:s,toggleDialog:s,continueButtonLabel:"credentialResetConfirm",onConfirm:()=>{l(d)()},confirmButtonDisabled:!p,children:k(Le,{id:"userCredentialsReset-form",isHorizontal:!0,"data-testid":"credential-reset-modal",children:[e(ir,{control:o,name:"actions",label:"resetAction",help:"resetActions"}),e(st,{...u,children:e(Gr,{})})]})})},qr={password:"",passwordConfirmation:"",temporaryPassword:!0},jr=({user:t,isResetPassword:s,onAddRequiredActions:r,refresh:u,onClose:l})=>{const{t:o}=N(),{register:c,control:p,formState:{isValid:m,errors:h},watch:d,handleSubmit:i,clearErrors:D,setError:b}=Ce({defaultValues:qr,mode:"onChange"}),[y,w]=Me(!0),E=d("password",""),Q=d("passwordConfirmation",""),{addAlert:X,addError:Y}=$(),[M,J]=he({titleKey:s?"resetPasswordConfirm":"setPasswordConfirm",messageKey:s?o("resetPasswordConfirmText",{username:t.username}):o("setPasswordConfirmText",{username:t.username}),continueButtonLabel:s?"resetPassword":"savePassword",continueButtonVariant:de.danger,onConfirm:()=>i(R)()}),R=async({password:n,temporaryPassword:f})=>{try{await g.users.resetPassword({id:t.id,credential:{temporary:f,type:"password",value:n}}),f&&r?.([Bt.UPDATE_PASSWORD]);const Z=(await g.users.getCredentials({id:t.id})).find(ae=>ae.type==="password");Z&&await g.users.updateCredentialLabel({id:t.id,credentialId:Z.id},o("defaultPasswordLabel")),X(o(s?"resetCredentialsSuccess":"savePasswordSuccess"),B.success),u()}catch(K){Y(s?"resetPasswordError":"savePasswordError",K)}l()},{onChange:x,...C}=c("password",{required:!0});return k(j,{children:[e(J,{}),e(ot,{titleKey:s?o("resetPasswordFor",{username:t.username}):o("setPasswordFor",{username:t.username}),open:y,onCancel:l,toggleDialog:w,onConfirm:M,confirmButtonDisabled:!m,continueButtonLabel:"save",children:k(Le,{id:"userCredentials-form",isHorizontal:!0,className:"keycloak__user-credentials__reset-form",children:[e(oe,{name:"password",label:o("password"),fieldId:"password",helperTextInvalid:o("required"),validated:h.password?V.error:V.default,isRequired:!0,children:e(Je,{"data-testid":"passwordField",id:"password",onChange:n=>{x(n),Q!==n.currentTarget.value?b("passwordConfirmation",{message:o("confirmPasswordDoesNotMatch").toString()}):D("passwordConfirmation")},...C})}),e(oe,{name:"passwordConfirmation",label:o(s?"resetPasswordConfirmation":"passwordConfirmation"),fieldId:"passwordConfirmation",helperTextInvalid:h.passwordConfirmation?.message,validated:h.passwordConfirmation?V.error:V.default,isRequired:!0,children:e(Je,{"data-testid":"passwordConfirmationField",id:"passwordConfirmation",...c("passwordConfirmation",{required:!0,validate:n=>n===E||o("confirmPasswordDoesNotMatch").toString()})})}),e(oe,{label:o("temporaryPassword"),labelIcon:e(Be,{helpText:o("temporaryPasswordHelpText"),fieldLabelId:"temporaryPassword"}),fieldId:"kc-temporaryPassword",children:e(at,{name:"temporaryPassword",defaultValue:!0,control:p,render:({field:n})=>e(Kt,{className:"kc-temporaryPassword",onChange:n.onChange,isChecked:n.value,label:o("on"),labelOff:o("off"),"aria-label":o("temporaryPassword")})})})]})})]})},Hr=({user:t,setUser:s})=>{const{t:r}=N(),{addAlert:u,addError:l}=$(),[o,c]=P(0),p=()=>c(o+1),[m,h]=P(!1),[d,i]=P(!1),[D,b]=P([]),[y,w]=P([]),[E,Q]=P({}),[X,Y]=P(!1),[M,J]=P(),R=pt(null),[x,C]=P({draggedItemId:"",draggingToItemIndex:-1,dragging:!1,tempItemOrder:[""]});Ee(()=>g.users.getCredentials({id:t.id}),a=>{b(a);const T=a.reduce((L,A)=>(L[A.type]=L[A.type]||[],L[A.type].push(A),L),Object.create(null)),I=Object.keys(T).map(L=>({key:L,value:T[L]}));w(I.map(L=>({...L,isExpanded:!1})))},[o]);const n=D.find(a=>a.type==="password"),f=()=>h(!m),K=()=>{i(!d)},Z=()=>{Y(!0),f()},[ae,le]=he({titleKey:r("deleteCredentialsConfirmTitle"),messageKey:r("deleteCredentialsConfirm"),continueButtonLabel:r("delete"),continueButtonVariant:de.danger,onConfirm:async()=>{try{await g.users.deleteCredential({id:t.id,credentialId:E.id}),u(r("deleteCredentialsSuccess"),B.success),c(a=>a+1)}catch(a){l("deleteCredentialsError",a)}}}),ce=({credential:a})=>e(Kr,{credential:a,toggleDelete:()=>{Q(a),ae()},resetPassword:Z,children:e(Or,{credential:a,userId:t.id,isEditable:M?.status&&M.rowKey===a.id||!1,toggle:()=>{J({status:!M?.status,rowKey:a.id}),M?.status&&p()}})},a.id),H=et(()=>y.flatMap(a=>[a.value.map(({id:T})=>T).toString(),...a.isExpanded?a.value.map(T=>T.id):[]]),[y]),fe=a=>{a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("text/plain",a.currentTarget.id);const T=a.currentTarget.id;a.currentTarget.classList.add(xe.modifiers.ghostRow),a.currentTarget.setAttribute("aria-pressed","true"),C({...x,draggedItemId:T,dragging:!0})},me=(a,T,I)=>{const L=a.indexOf(T);if(L===I)return a;const A=[...a];return A.splice(I,0,A.splice(L,1)[0]),A},ge=a=>{if(!R.current)return;const T=R.current,I=Array.from(T.children);I.every(({id:L},A)=>L===a[A])||(T.replaceChildren(),a.forEach(L=>{T.appendChild(I.find(({id:A})=>A===L))}))},Ae=()=>{R.current&&(Array.from(R.current.children).forEach(a=>{a.classList.remove(xe.modifiers.ghostRow),a.setAttribute("aria-pressed","false")}),C({...x,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},Re=a=>{ve(a)||(ge(H),C({...x,draggingToItemIndex:-1}))},ve=a=>{if(!R.current)return!1;const T=R.current.getBoundingClientRect();return a.clientX>T.x&&a.clientX<T.x+T.width&&a.clientY>T.y&&a.clientY<T.y+T.height},Ie=a=>{ve(a)?te(x.draggedItemId,x.tempItemOrder):Ae()},v=a=>{a.preventDefault();const I=a.target.closest("tr");if(!(!I||R.current&&!R.current.contains(I)||I.id===x.draggedItemId)){const L=I.id,A=Array.from(R.current?.children||[]).findIndex(O=>O.id===L);if(A===x.draggingToItemIndex)return;const se=me(H,x.draggedItemId,A);ge(se),C({...x,draggingToItemIndex:A,tempItemOrder:se})}},ee=a=>{s({...t,requiredActions:[...t.requiredActions??[],...a]})},W=({target:a})=>{a instanceof HTMLTableRowElement&&(a.classList.remove(xe.modifiers.ghostRow),a.setAttribute("aria-pressed","false"),C({...x,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},te=async(a,T)=>{const I=H.findIndex(O=>O===a),L=T.findIndex(O=>O===a),A=L-I,se=a.split(",");try{for(const O of se)for(let je=0;je<Math.abs(A);je++)A>0?await g.users.moveCredentialPositionDown({id:t.id,credentialId:O,newPreviousCredentialId:H[L]}):await g.users.moveCredentialPositionUp({id:t.id,credentialId:O});p(),u(r("updatedCredentialMoveSuccess"),B.success)}catch(O){l("updatedCredentialMoveError",O)}},_=t.federationLink||t.origin,[z,re]=P([]);if(Ee(()=>g.users.getUserStorageCredentialTypes({id:t.id}),re,[]),!z)return e(nt,{});const ue=z.length>0,be=y.length===0,ut=!t.credentials||t.credentials.length===0,qe=be&&ut&&!ue;return k(j,{children:[m&&e(jr,{user:t,isResetPassword:X,onAddRequiredActions:ee,refresh:p,onClose:()=>h(!1)}),d&&e(Vr,{userId:t.id,onClose:()=>i(!1)}),e(le,{}),t.email&&!qe&&e(U,{className:"kc-resetCredentialBtn-header",variant:"primary","data-testid":"credentialResetBtn",onClick:()=>i(!0),children:r("credentialResetBtn")}),D.length!==0&&n===void 0&&k(j,{children:[e(U,{className:"kc-setPasswordBtn-tbl","data-testid":"setPasswordBtn-table",variant:"primary",form:"userCredentials-form",onClick:()=>{h(!0)},children:r("setPassword")}),e(Ot,{})]}),y.length!==0&&e(pe,{variant:Se.light,children:k(Qe,{variant:"compact",children:[e(Xe,{children:k(ye,{className:"kc-table-header",children:[e(q,{children:e(Be,{helpText:r("userCredentialsHelpText"),fieldLabelId:"userCredentialsHelpTextLabel"})}),e(q,{"aria-hidden":"true"}),e(q,{children:r("type")}),e(q,{children:r("userLabel")}),e(q,{children:r("createdAt")}),e(q,{children:r("data")}),e(q,{"aria-hidden":"true"}),e(q,{"aria-hidden":"true"})]})}),e(Ye,{ref:R,onDragOver:v,onDrop:v,onDragLeave:Re,children:y.map((a,T)=>k(ht,{children:[k(ye,{id:a.value.map(({id:I})=>I).toString(),draggable:y.length>1,onDrop:Ie,onDragEnd:W,onDragStart:fe,children:[e(S,{className:y.length===1?"one-row":"",draggableRow:{id:`draggable-row-${a.value.map(({id:I})=>I)}`}}),a.value.length>1?e(S,{className:"kc-expandRow-btn",expand:{rowIndex:T,isExpanded:a.isExpanded,onToggle:(I,L)=>{const A=y.map((se,O)=>O===L?{...se,isExpanded:!se.isExpanded}:se);w(A)}}}):e(S,{}),e(S,{dataLabel:`columns-${a.key}`,className:"kc-notExpandableRow-credentialType","data-testid":"credentialType",children:We(a.key)}),a.value.length<=1&&a.value.map(I=>e(ce,{credential:I},I.id))]}),a.isExpanded&&a.value.map(I=>k(ye,{id:I.id,draggable:!0,onDrop:Ie,onDragEnd:W,onDragStart:fe,children:[e(S,{}),e(S,{className:"kc-draggable-dropdown-type-icon",draggableRow:{id:`draggable-row-${a.value.map(({id:L})=>L)}`}}),e(S,{dataLabel:`child-columns-${I.id}`,className:"kc-expandableRow-credentialType",children:We(I.type)}),e(ce,{credential:I})]},I.id))]},a.key))})]})}),_&&ue&&e(pe,{variant:Se.light,children:k(Qe,{variant:"compact",children:[e(Xe,{children:k(ye,{children:[e(q,{children:r("type")}),e(q,{children:r("providedBy")}),e(q,{"aria-hidden":"true"})]})}),e(Ye,{children:z.map(a=>k(ye,{children:[e(S,{children:e("b",{children:a})}),e(S,{children:e(or,{user:t})}),a==="password"&&e(S,{modifier:"fitContent",children:e(U,{variant:"secondary",onClick:f,children:r("setPassword")})})]},a))})]})}),qe&&e(Ge,{hasIcon:!0,message:r("noCredentials"),instructions:r("noCredentialsText"),primaryActionText:r("setPassword"),onPrimaryAction:f,secondaryActions:t.email?[{text:r("credentialResetBtn"),onClick:K,type:de.link}]:void 0})]})},Wr=({user:t})=>{const{t:s}=N(),{addAlert:r,addError:u}=$(),[l,o]=P(0),c=()=>o(l+1),[p,m]=P([]),[h,d]=P(!0),[i,D]=P([]),[b,y]=P(!1),{enabled:w}=Gt(),{hasAccess:E}=it(),Q=E("manage-users"),X=n=>lt(n,f=>f.path?.toUpperCase()),Y=async(n,f,K)=>{const Z={first:n,max:f},ae=K||"";ae&&(Z.search=ae);const le=await g.users.listGroups({...Z,id:t.id});D([...le]);const ce=[];return h||le.forEach(H=>{const fe=H.path?.substring(1).split("/").slice(0,-1)||[];ce.push(...fe.map(me=>({name:me,path:H.path?.substring(0,H.path.indexOf(me)+me.length)})))}),X(jt([...le,...ce],"path"))},M=()=>{y(!b)},[J,R]=he({titleKey:s("leaveGroup",{count:p.length,name:p[0]?.name}),messageKey:s("leaveGroupConfirmDialog",{count:p.length,groupname:p[0]?.name,username:t.username}),continueButtonLabel:"leave",continueButtonVariant:de.danger,onConfirm:async()=>{try{await Promise.all(p.map(n=>g.users.delFromGroup({id:t.id,groupId:n.id}))),r(s("removedGroupMembership"),B.success)}catch(n){u("removedGroupMembershipError",n)}c()}}),x=n=>{m(n),J()},C=async n=>{try{await Promise.all(n.map(f=>g.users.addToGroup({id:t.id,groupId:f.id}))),r(s("addedGroupMembership"),B.success)}catch(f){u("addedGroupMembershipError",f)}c()};return k(j,{children:[e(R,{}),b&&e(Ir,{id:t.id,type:"selectMany",text:{title:s("joinGroupsFor",{username:t.username}),ok:"join"},canBrowse:Q,onClose:()=>y(!1),onConfirm:async(n=[])=>{await C(n),y(!1)}}),e(De,{loader:Y,className:"keycloak_user-section_groups-table",isPaginated:!0,ariaLabelKey:"roleList",searchPlaceholderKey:"searchGroup",canSelectAll:!0,onSelect:n=>m(h?n:xr(n,i,"id")),isRowDisabled:n=>!h&&i.every(f=>f.id!==n.id),toolbarItem:k(j,{children:[e(U,{className:"kc-join-group-button",onClick:M,"data-testid":"add-group-button",isDisabled:!t.access?.manageGroupMembership,children:s("joinGroup")}),e(Vt,{label:s("directMembership"),id:"kc-direct-membership-checkbox",onChange:()=>{d(!h),c()},isChecked:h,className:"direct-membership-check"},"direct-membership-check"),e(U,{onClick:()=>x(p),"data-testid":"leave-group-button",variant:"link",isDisabled:p.length===0,children:s("leave")}),w&&e(qt,{"aria-label":"Basic popover",position:"bottom",bodyContent:e("div",{children:s("whoWillAppearPopoverTextUsers")}),children:e(U,{variant:"link",className:"kc-who-will-appear-button",icon:e(Tr,{}),children:s("whoWillAppearLinkTextUsers")},"who-will-appear-button")})]}),columns:[{name:"groupMembership",displayKey:"groupMembership",cellRenderer:n=>n.name||"",cellFormatters:[G()],transforms:[F(40)]},{name:"path",displayKey:"path",cellRenderer:n=>e(kr,{group:n}),transforms:[F(45)]},{name:"",cellRenderer:n=>i.some(K=>K.id===n.id)||i.length===0||h?e(U,{"data-testid":`leave-${n.name}`,onClick:()=>x([n]),variant:"link",isDisabled:!t.access?.manageGroupMembership,children:s("leave")}):"",cellFormatters:[G()],transforms:[F(20)]}],emptyState:e(Ge,{hasIcon:!0,message:s("noGroups"),instructions:s("noGroupsText"),primaryActionText:s("joinGroup"),onPrimaryAction:M})},l)]})},_r=({userId:t,federatedId:s,onClose:r,onRefresh:u})=>{const{t:l}=N(),{addAlert:o,addError:c}=$(),{register:p,handleSubmit:m,formState:{isValid:h,errors:d}}=Ce({mode:"onChange"}),i=async D=>{try{await g.users.addToFederatedIdentity({id:t,federatedIdentityId:s,federatedIdentity:D}),o(l("idpLinkSuccess"),B.success),r(),u()}catch(b){c("couldNotLinkIdP",b)}};return e(ct,{variant:Ve.small,title:l("linkAccountTitle",{provider:we(s)}),onClose:r,actions:[e(U,{"data-testid":"confirm",variant:"primary",type:"submit",form:"group-form",isDisabled:!h,children:l("link")},"confirm"),e(U,{"data-testid":"cancel",variant:de.link,onClick:r,children:l("cancel")},"cancel")],isOpen:!0,children:k(Le,{id:"group-form",onSubmit:m(i),children:[e(oe,{label:l("identityProvider"),fieldId:"identityProvider",children:e(Te,{id:"identityProvider","data-testid":"idpNameInput",value:we(s),isReadOnly:!0})}),e(oe,{label:l("userID"),fieldId:"userID",helperText:l("userIdHelperText"),helperTextInvalid:l("required"),validated:d.userId?V.error:V.default,isRequired:!0,children:e(Te,{id:"userID","data-testid":"userIdInput",validated:d.userId?V.error:V.default,autoFocus:!0,...p("userId",{required:!0})})}),e(oe,{label:l("username"),fieldId:"username",helperText:l("usernameHelperText"),helperTextInvalid:l("required"),validated:d.userName?V.error:V.default,isRequired:!0,children:e(Te,{id:"username","data-testid":"usernameInput",validated:d.userName?V.error:V.default,...p("userName",{required:!0})})})]})})},zr=({userId:t})=>{const[s,r]=P(0),[u,l]=P(""),[o,c]=P(!1),{realm:p}=Ke(),{addAlert:m,addError:h}=$(),{t:d}=N(),i=()=>r(new Date().getTime()),D=Ht().identityProviders,b=async()=>{const C=await g.identityProviders.find(),n=await g.users.listFederatedIdentities({id:t});for(const f of n)f.providerId=C.find(K=>K.alias===f.identityProvider)?.providerId;return n},y=async()=>(await g.realms.findOne({realm:p})).identityProviders,w=async()=>b(),E=async()=>{const C=(await b()).map(n=>n.identityProvider);return(await y())?.filter(n=>!C.includes(n.alias))},[Q,X]=he({titleKey:d("unlinkAccountTitle",{provider:we(u)}),messageKey:d("unlinkAccountConfirm",{provider:we(u)}),continueButtonLabel:"unlink",continueButtonVariant:de.primary,onConfirm:async()=>{try{await g.users.delFromFederatedIdentity({id:t,federatedIdentityId:u}),m(d("idpUnlinkSuccess"),B.success),i()}catch(C){h("mappingDeletedError",C)}}}),Y=C=>e(_t,{to:zt({realm:p,providerId:C.providerId,alias:C.identityProvider,tab:"settings"}),children:we(C.identityProvider)}),M=C=>{const n=D?.find(f=>f.id===C.identityProvider)?.groupName;return e(Fe,{color:n==="Social"?"blue":"orange",children:d(n==="Social"?"idpType.social":"idpType.custom")})},J=C=>{const n=D?.find(f=>f.id===C.providerId)?.groupName;return e(Fe,{color:n==="User-defined"?"orange":"blue",children:n==="User-defined"?"Custom":n==="Social"?d("idpType.social"):n})},R=C=>e(U,{variant:"link",onClick:()=>{l(C.identityProvider),Q()},children:d("unlinkAccount")}),x=C=>e(U,{variant:"link",onClick:()=>{l(C.alias),c(!0)},children:d("linkAccount")});return k(j,{children:[o&&e(_r,{userId:t,federatedId:u,onClose:()=>c(!1),onRefresh:i}),e(X,{}),k(pe,{variant:"light",className:"pf-u-p-0",children:[k(_e,{title:d("linkedIdPs"),className:"kc-linked-idps",children:[e(ke,{children:e(Pe,{className:"kc-available-idps-text",children:d("linkedIdPsText")})}),e(De,{loader:w,isPaginated:!1,ariaLabelKey:"LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"identityProvider",displayKey:"name",cellFormatters:[G()],cellRenderer:Y,transforms:[F(20)]},{name:"type",displayKey:"type",cellFormatters:[G()],cellRenderer:M,transforms:[F(10)]},{name:"userId",displayKey:"userID",cellFormatters:[G()],transforms:[F(30)]},{name:"userName",displayKey:"username",cellFormatters:[G()],transforms:[F(20)]},{name:"",cellFormatters:[G()],cellRenderer:R,transforms:[F(20)]}],emptyState:e(ke,{className:"kc-no-providers-text",children:e(Pe,{children:d("noProvidersLinked")})})},s)]}),k(_e,{className:"kc-available-idps",title:d("availableIdPs"),children:[e(ke,{children:e(Pe,{className:"kc-available-idps-text",children:d("availableIdPsText")})}),e(De,{loader:E,isPaginated:!1,ariaLabelKey:"LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"alias",displayKey:"name",cellFormatters:[G(),Wt()],transforms:[F(20)]},{name:"type",displayKey:"type",cellFormatters:[G()],cellRenderer:J,transforms:[F(60)]},{name:"",cellFormatters:[G()],cellRenderer:x}],emptyState:e(ke,{className:"kc-no-providers-text",children:e(Pe,{children:d("noAvailableIdentityProviders")})})},s)]})]})]})},$r=({id:t,name:s})=>{const{t:r}=N(),{addAlert:u,addError:l}=$();return e(Dr,{name:s,id:t,type:"users",save:async c=>{try{const p=c.filter(m=>m.client===void 0).map(m=>m.role).flat();await g.users.addRealmRoleMappings({id:t,roles:p}),await Promise.all(c.filter(m=>m.client!==void 0).map(m=>g.users.addClientRoleMappings({id:t,clientUniqueId:m.client.id,roles:[m.role]}))),u(r("userRoleMappingUpdatedSuccess"),B.success)}catch(p){l("roleMappingUpdatedError",p)}}})},Qr=()=>{const{id:t}=Oe(),{realm:s}=Ke(),{t:r}=N();return e(pe,{variant:"light",className:"pf-u-p-0",children:e(wr,{loader:()=>g.users.listSessions({id:t,realm:s}),hiddenColumns:["username","type"],emptyInstructions:r("noSessionsForUser"),logoutUser:t})})},Xr=t=>$t(`ui-ext/users/${t}/unmanagedAttributes`);function $a(){const{t}=N(),{addAlert:s,addError:r}=$(),u=Qt(),{hasAccess:l}=it(),{id:o}=Oe(),{realm:c}=Ke(),m=Ce({mode:"onChange",resolver:async v=>({values:v,errors:{}})}),[h,d]=P(),[i,D]=P(),[b,y]=P(),[w,E]=P(),[Q,X]=P(),[Y,M]=P(0),J=()=>M(v=>v+1),R=Cr(i?.id),[x,C]=P(),n=v=>Zt({realm:c,id:i?.id||"",tab:v}),f=v=>rr(n(v)),K=f("settings"),Z=f("attributes"),ae=f("credentials"),le=f("role-mapping"),ce=f("groups"),H=f("consents"),fe=f("identity-provider-links"),me=f("sessions");Ee(async()=>Promise.all([g.realms.findOne({realm:c}),g.users.findOne({id:o,userProfileMetadata:!0}),g.attackDetection.findOne({id:o}),Xr(o),g.users.getProfile({realm:c})]),([v,ee,W,te,_])=>{if(!ee||!v||!W)throw new Error(t("notFound"));const{userProfileMetadata:z,...re}=ee;X(z),re.unmanagedAttributes=te,re.attributes=cr(re.attributes,te),_.unmanagedAttributePolicy!==void 0&&E(!0),d(v),D(re),C(_);const ue=v.bruteForceProtected,be=ue&&W.disabled;y({isBruteForceProtected:ue,isLocked:be}),m.reset(Ne(re))},[Y]);const ge=async v=>{try{await g.users.update({id:i.id},lr(v)),s(t("userSaved"),B.success),J()}catch(ee){if(er(ee)){if(w&&Array.isArray(v.unmanagedAttributes)){const W=new Array(v.unmanagedAttributes.length);let te=!1;ze(ee,(_,z)=>{if(_.startsWith("attributes.")){const re=_.substring(11);v.unmanagedAttributes.forEach((ue,be)=>{ue.key===re&&(W[be]=z,te=!0)})}else m.setError(_,z)},(_,z)=>t(_,z)),te&&m.setError("unmanagedAttributes",W)}else ze(ee,m.setError,(W,te)=>t(W,te));r("userNotSaved","")}else r("userCreateError",ee)}},[Ae,Re]=he({titleKey:"deleteConfirm",messageKey:"deleteConfirmCurrentUser",continueButtonLabel:"delete",continueButtonVariant:de.danger,onConfirm:async()=>{try{R?await g.users.logout({id:i.id}):await g.users.del({id:i.id}),s(t("userDeletedSuccess"),B.success),u(Xt({realm:c}))}catch(v){r("userDeletedError",v)}}}),[ve,Ie]=he({titleKey:"impersonateConfirm",messageKey:"impersonateConfirmDialog",continueButtonLabel:"impersonate",onConfirm:async()=>{try{const v=await g.users.impersonation({id:i.id},{user:i.id,realm:c});v.sameRealm?window.location=v.redirect:window.open(v.redirect,"_blank")}catch(v){r("impersonateError",v)}}});return!h||!i||!b?e(nt,{}):k(j,{children:[e(Ie,{}),e(Re,{}),e(ar,{titleKey:i.username,className:"kc-username-view-header",divider:!1,badges:R?[{text:e(Yt,{content:t("transientUserTooltip"),children:e(Fe,{"data-testid":"user-details-label-transient-user",icon:e(Jt,{}),children:t("transientUser")})})}]:[],dropdownItems:[e(Ue,{isDisabled:!i.access?.impersonate,onClick:()=>ve(),children:t("impersonate")},"impersonate"),e(Ue,{isDisabled:!i.access?.manage,onClick:()=>Ae(),children:t("delete")},"delete")],onToggle:v=>ge({...Ne(i),enabled:v}),isEnabled:i.enabled}),e(pe,{variant:"light",className:"pf-u-p-0",children:e(sr,{children:e(st,{...m,children:k(tr,{isBox:!0,mountOnEnter:!0,defaultLocation:n("settings"),children:[e(ne,{"data-testid":"user-details-tab",title:e(ie,{children:t("details")}),...K,children:e(pe,{variant:"light",children:e(dr,{form:m,realm:h,user:i,bruteForce:b,userProfileMetadata:Q,save:ge})})}),w&&e(ne,{"data-testid":"attributes",title:e(ie,{children:t("attributes")}),...Z,children:e(Nr,{user:i,save:ge,upConfig:x})}),e(ne,{"data-testid":"credentials",isHidden:!i.access?.view,title:e(ie,{children:t("credentials")}),...ae,children:e(Hr,{user:i,setUser:D})}),e(ne,{"data-testid":"role-mapping-tab",isHidden:!i.access?.view,title:e(ie,{children:t("roleMapping")}),...le,children:e($r,{id:i.id,name:i.username})}),l("query-groups")&&e(ne,{"data-testid":"user-groups-tab",title:e(ie,{children:t("groups")}),...ce,children:e(Wr,{user:i})}),e(ne,{"data-testid":"user-consents-tab",title:e(ie,{children:t("consents")}),...H,children:e(Mr,{})}),l("view-identity-providers")&&e(ne,{"data-testid":"identity-provider-links-tab",title:e(ie,{children:t("identityProviderLinks")}),...fe,children:e(zr,{userId:i.id})}),e(ne,{"data-testid":"user-sessions-tab",title:e(ie,{children:t("sessions")}),...me,children:e(Qr,{})})]})})})})]})}export{$a as default};
//# sourceMappingURL=EditUser-BqsBjn5_.js.map
