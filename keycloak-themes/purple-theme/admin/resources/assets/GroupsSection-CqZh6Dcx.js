import{jsxs as C,jsx as e,Fragment as k}from"react/jsx-runtime";import*as J from"react";import{useEffect as be,useState as g}from"react";import{_ as oe,k as ie,bQ as Y,m as ye,u as D,bR as z,b as ee,bs as j,bS as fe,bT as re,L as H,e as W,g as Ge,q as te,P as ce,bU as le,bx as we,M as ve,f as h,N as Me,A as B,aR as Q,h as $,O as de,aq as ue,D as _,ar as V,U as Ce,bz as Se,be as Te,bV as Ke,c as Pe,bK as Ae,ay as Ie,az as Re,bW as ke,bX as De,K as Ne,bN as Fe,ag as Ee}from"./index-C9t2UlUN.js";import{P as Le}from"./PermissionTab-Cqx0kVF9.js";import{V as Oe}from"./ViewHeader-cxZm8XhN.js";import{u as xe,F as Ue}from"./useIsFeatureEnabled-CkHhuO9z.js";import{u as q}from"./useToggle-K3Kx99tM.js";import{A as Ve}from"./AttributeForm-CF8uy5gF.js";import{R as Be}from"./AddRoleMappingModal-BWNuJU0W.js";import{S as $e,L as se}from"./PaginatingTableToolbar-oQUfBy2J.js";import{a1 as ae,ah as qe}from"./KeycloakDataTable-2rLFZPhG.js";import{D as me,a as Z,M as ze,b as je,c as He}from"./GroupPickerDialog-tI6XV7Ln.js";import{b as E}from"./ToolbarContent-D6TJq6fk.js";import{M as _e,a as We}from"./Modal-Bgkd26UL.js";import{T as Qe,a as x,b as U}from"./Tabs-CjrDEqsl.js";import"react-dom";import"./ConfirmDialog-BDkqxnFL.js";import"./Trans-DcN6j3pV.js";import"./Form-Cdw1qhWG.js";import"./FormAccess-DnQCcStE.js";import"./copy-icon-CYSS18Ce.js";import"./KeyValueInput-BJlDoGlu.js";import"./KeycloakTextInput-DrlF32nr.js";import"./KeySelect-CPI9XGq0.js";import"./EmptyStateBody-CyIhnUop.js";import"./filter-icon-C8nM2k1N.js";import"./EmptyStateSecondaryActions-BekVwNvY.js";import"./grip-vertical-icon-B_ub3hpF.js";import"./_baseFlatten-BQ8y46Zj.js";import"./DataListItemRow-Bimi62Tu.js";import"./MenuList-Br-Zu33q.js";const pe=t=>{var{className:s="",children:o,hasNoPadding:r=!1}=t,c=oe(t,["className","children","hasNoPadding"]);return J.createElement("div",Object.assign({className:ie(Y.drawerBody,r&&Y.modifiers.noPadding,s)},c),o)};pe.displayName="DrawerPanelBody";const he=t=>{var{className:s="",children:o,hasNoPadding:r=!1}=t,c=oe(t,["className","children","hasNoPadding"]);return J.createElement(pe,{hasNoPadding:r},J.createElement("div",Object.assign({className:ie(Y.drawerHead,s)},c),o))};he.displayName="DrawerHead";const Xe={name:"TreeIcon",height:512,width:384,svgPath:"M378.31 378.49L298.42 288h30.63c9.01 0 16.98-5 20.78-13.06 3.8-8.04 2.55-17.26-3.28-24.05L268.42 160h28.89c9.1 0 17.3-5.35 20.86-13.61 3.52-8.13 1.86-17.59-4.24-24.08L203.66 4.83c-6.03-6.45-17.28-6.45-23.32 0L70.06 122.31c-6.1 6.49-7.75 15.95-4.24 24.08C69.38 154.65 77.59 160 86.69 160h28.89l-78.14 90.91c-5.81 6.78-7.06 15.99-3.27 24.04C37.97 283 45.93 288 54.95 288h30.63L5.69 378.49c-6 6.79-7.36 16.09-3.56 24.26 3.75 8.05 12 13.25 21.01 13.25H160v24.45l-30.29 48.4c-5.32 10.64 2.42 23.16 14.31 23.16h95.96c11.89 0 19.63-12.52 14.31-23.16L224 440.45V416h136.86c9.01 0 17.26-5.2 21.01-13.25 3.8-8.17 2.44-17.47-3.56-24.26z",yOffset:0,xOffset:0},Je=ye(Xe),Ye=()=>{const{t}=D(),{clear:s,remove:o,subGroups:r}=z(),{realm:c}=ee(),n=j();return be(()=>{const{pathname:i}=n;(!i.includes("/groups")||i.endsWith("/groups"))&&s()},[n]),r.length!==0?C(fe,{children:[e(re,{children:e(H,{to:`/${c}/groups`,children:t("groups")})},"home"),r.map((i,u)=>{const a=u===r.length-1;return C(re,{isActive:a,children:[!a&&e(H,{to:n.pathname.substring(0,n.pathname.indexOf(i.id)+i.id.length),onClick:()=>o(i),children:i.name}),a&&(i.id==="search"?i.name:t("groupDetails"))]},i.id)})]}):null},ge=t=>{const s=t.substr(1).split("/");return s.length>1?s.splice(2):void 0},X=t=>{const s=ge(t);return s?s[s.length-1]:void 0},Ze=()=>{const{t}=D(),{addAlert:s,addError:o}=W(),r=Ge({mode:"onChange"}),c=j(),n=X(c.pathname),[i,u]=g();te(()=>h.groups.findOne({id:n}),b=>{ve(b,r.setValue),u(b)},[n]);const a=async b=>{try{const G=Me(b).attributes;await h.groups.update({id:n},{...i,attributes:G}),u({...i,attributes:G}),s(t("groupUpdated"),B.success)}catch(G){o("groupUpdateError",G)}};return e(ce,{variant:le.light,children:e(Ve,{form:r,save:a,fineGrainedAccess:i?.access?.manage,reset:()=>r.reset({attributes:we(i?.attributes)})})})},et=({id:t,name:s})=>{const{t:o}=D(),{addAlert:r,addError:c}=W();return e(Be,{name:s,id:t,type:"groups",save:async i=>{try{const u=i.filter(a=>a.client===void 0).map(a=>a.role).flat();await h.groups.addRealmRoleMappings({id:t,roles:u}),await Promise.all(i.filter(a=>a.client!==void 0).map(a=>h.groups.addClientRoleMappings({id:t,clientUniqueId:a.client.id,roles:[a.role]}))),r(o("roleMappingUpdatedSuccess"),B.success)}catch(u){c("roleMappingUpdatedError",u)}}})},tt=({toggleCreate:t,toggleDelete:s,kebabDisabled:o})=>{const{t:r}=D(),{currentGroup:c}=z(),{hasAccess:n}=Q(),i=n("manage-users")||c()?.access?.manage,[u,a]=q();return i?C(k,{children:[e(E,{children:e($,{"data-testid":"openCreateGroupModal",variant:"primary",onClick:t,children:r("createGroup")})}),e(E,{children:e(de,{toggle:e(ue,{onToggle:a,isDisabled:o}),isOpen:u,isPlain:!0,dropdownItems:[e(_,{component:"button",onClick:()=>{s(),a()},children:r("delete")},"action")]})})]}):e("div",{})},ne=({refresh:t})=>{const{t:s}=D(),[o,r]=g([]),[c,n]=g(),[i,u]=q(),[a,b]=q(),[G,w]=g(),{currentGroup:P}=z(),[p,S]=g(0),T=()=>S(p+1),[I,A]=g(),K=j(),y=X(K.pathname),{hasAccess:L}=Q(),O=L("manage-users")||P()?.access?.manage,N=async(d,m)=>{let v;if(y){const l={first:d,max:m,parentId:y};v=await h.groups.listSubGroups(l)}else{const l={search:I||"",first:d||void 0,max:m||void 0};v=await h.groups.find(l)}return v};return C(k,{children:[e(me,{show:a,toggleDialog:b,selectedRows:o,refresh:()=>{T(),t(),r([])}}),c&&e(Z,{id:c.id,rename:c,refresh:()=>{T(),t()},handleModalToggle:()=>n(void 0)}),i&&e(Z,{id:o[0]?.id||y,handleModalToggle:u,refresh:()=>{r([]),T(),t()}}),G&&e(ze,{source:G,refresh:()=>{w(void 0),T(),t()},onClose:()=>w(void 0)}),e(ae,{onSelect:d=>r([...d]),canSelectAll:!0,loader:N,ariaLabelKey:"groups",isPaginated:!0,isSearching:!!I,toolbarItem:C(k,{children:[e(E,{children:e($e,{"data-testid":"group-search",placeholder:s("filterGroups"),value:I,onChange:(d,m)=>{A(m)},onSearch:T,onClear:()=>{A(""),T()}})}),e(tt,{toggleCreate:u,toggleDelete:b,kebabDisabled:o.length===0})]}),actions:O?[{title:s("rename"),onRowClick:async d=>(n(d),!1)},{title:s("moveTo"),onRowClick:async d=>(w(d),!1)},{title:s("createChildGroup"),onRowClick:async d=>(r([d]),u(),!1)},{isSeparator:!0},{title:s("delete"),onRowClick:async d=>(r([d]),b(),!0)}]:[],columns:[{name:"name",displayKey:"groupName",cellRenderer:d=>d.access?.view?e(H,{to:`${K.pathname}/${d.id}`,children:d.name},d.id):e("span",{children:d.name})}],emptyState:e(se,{hasIcon:!0,message:s(`noGroupsInThis${y?"SubGroup":"Realm"}`),instructions:s(`noGroupsInThis${y?"SubGroup":"Realm"}Instructions`),primaryActionText:s("createGroup"),onPrimaryAction:u})},`${y}${p}`)]})},st=({groupId:t,onClose:s})=>{const{t:o}=D(),{addAlert:r,addError:c}=W(),[n,i]=g([]),u=async(a,b,G)=>{const w=await h.groups.listMembers({id:t}),P={first:a,max:b+w.length,search:G||""};try{const p=await h.users.find({...P});return qe(p,w,"id").slice(0,b)}catch(p){return c("noUsersFoundError",p),[]}};return e(_e,{variant:We.large,title:o("addMember"),isOpen:!0,onClose:s,actions:[e($,{"data-testid":"add",variant:"primary",onClick:async()=>{try{await Promise.all(n.map(a=>h.users.addToGroup({id:a.id,groupId:t}))),s(),r(o("usersAdded",{count:n.length}),B.success)}catch(a){c("usersAddedError",a)}},children:o("add")},"confirm"),e($,{"data-testid":"cancel",variant:"link",onClick:s,children:o("cancel")},"cancel")],children:e(ae,{loader:u,isPaginated:!0,ariaLabelKey:"titleUsers",searchPlaceholderKey:"searchForUser",canSelectAll:!0,onSelect:a=>i([...a]),emptyState:e(se,{message:o("noUsersFound"),instructions:o("emptyInstructions")}),columns:[{name:"username",displayKey:"username"},{name:"email",displayKey:"email"},{name:"lastName",displayKey:"lastName",cellFormatters:[V()]},{name:"firstName",displayKey:"firstName",cellFormatters:[V()]}]})})},at=t=>e(k,{children:t.membership.map((s,o)=>C(k,{children:[e(je,{group:s},s.id+"-"+t.id),t.membership[o+1]?", ":""]}))}),rt=t=>{const{realm:s}=ee();return e(H,{to:Te({realm:s,id:t.id,tab:"settings"}),children:t.username},t.id)},nt=()=>{const{t}=D(),{addAlert:s,addError:o}=W(),r=j(),c=X(r.pathname),[n,i]=g(!1),{currentGroup:u}=z(),[a,b]=g(),[G,w]=g(!1),[P,p]=g(!1),[S,T]=g([]),{hasAccess:I}=Q();te(()=>h.groups.findOne({id:u().id}),b,[]);const A=I("manage-users")||a?.access.manageMembership,[K,y]=g(0),L=()=>y(new Date().getTime()),O=async m=>await h.users.listGroups({id:m}),N=async(m,v=0)=>{let l=[];if(!v||!m)return l;const F={parentId:m,first:0,max:v},M=await h.groups.listSubGroups(F);return l=l.concat(M),await Promise.all(M.map(f=>N(f.id,f.subGroupCount))).then(f=>{f.forEach(R=>l=l.concat(R))}),l},d=async(m,v)=>{if(!c)return[];let l=await h.groups.listMembers({id:c,first:m,max:v});if(n&&a?.subGroupCount&&a.id){const M=await N(a.id,a.subGroupCount);await Promise.all(M.map(f=>h.groups.listMembers({id:f.id}))).then(f=>{f.forEach(R=>l=l.concat(R))}),l=Ke(l,f=>f.username)}const F=await Promise.all(l.map(M=>O(M.id)));return l.map((M,f)=>({...M,membership:F[f]}))};return a?C(k,{children:[G&&e(st,{groupId:c,onClose:()=>{w(!1),L()}}),e(ae,{"data-testid":"members-table",loader:d,ariaLabelKey:"members",isPaginated:!0,canSelectAll:!0,onSelect:m=>T([...m]),toolbarItem:A&&C(k,{children:[e(E,{children:e($,{"data-testid":"addMember",variant:"primary",onClick:()=>w(!0),children:t("addMember")})}),e(E,{children:e(Se,{"data-testid":"includeSubGroupsCheck",label:t("includeSubGroups"),id:"kc-include-sub-groups",isChecked:n,onChange:()=>i(!n)})}),e(E,{children:e(de,{toggle:e(ue,{onToggle:()=>p(!P),isDisabled:S.length===0}),isOpen:P,isPlain:!0,dropdownItems:[e(_,{component:"button",onClick:async()=>{try{await Promise.all(S.map(m=>h.users.delFromGroup({id:m.id,groupId:c}))),p(!1),s(t("usersLeft",{count:S.length}),B.success)}catch(m){o("usersLeftError",m)}L()},children:t("leave")},"action")]})})]}),actions:A?[{title:t("leave"),onRowClick:async m=>{try{await h.users.delFromGroup({id:m.id,groupId:c}),s(t("usersLeft",{count:1}),B.success)}catch(v){o("usersLeftError",v)}return!0}}]:[],columns:[{name:"username",displayKey:"name",cellRenderer:rt},{name:"email",displayKey:"email",cellFormatters:[V()]},{name:"firstName",displayKey:"firstName",cellFormatters:[V()]},{name:"lastName",displayKey:"lastName",cellFormatters:[V()]},{name:"membership",displayKey:"membership",cellRenderer:at}],emptyState:e(se,{message:t("noUsersFound"),instructions:A?t("emptyInstructions"):void 0,primaryActionText:A?t("addMember"):void 0,onPrimaryAction:()=>w(!0),secondaryActions:[{text:t("includeSubGroups"),onClick:()=>i(!0)}]})},`${c}${K}${n}`)]}):e(Ce,{})};function Ot(){const{t}=D(),[s,o]=g(0),{subGroups:r,setSubGroups:c,currentGroup:n}=z(),{realm:i}=ee(),[u,a]=g(),[b,G]=q(),w=Pe(),P=j(),p=X(P.pathname),[S,T]=q(!0),[I,A]=g(0),K=()=>A(I+1),{hasAccess:y}=Q(),O=xe()(Ue.AdminFineGrainedAuthz)&&y("manage-authorization","manage-users","manage-clients"),N=y("manage-users")||n()?.access?.manage,d=y("manage-users"),m=y("query-groups","view-users")||y("manage-users","query-groups"),v=y("view-users")||n()?.access?.viewMembers||n()?.access?.manageMembers;return te(async()=>{const l=ge(P.pathname);if(l&&l.length>r.length){const M=[];for(const f of l){let R;if(f!=="search"?R=await h.groups.findOne({id:f}):R={name:t("searchGroups"),id:"search"},R)M.push(R);else throw new Error(t("notFound"))}return M}return[]},l=>{l.length&&c(l)},[p]),C(k,{children:[e(me,{show:b,toggleDialog:G,selectedRows:[n()],refresh:()=>{w(Ae({realm:i})),K()}}),u&&e(Z,{id:p,rename:u,refresh:l=>{K(),c([...r.slice(0,r.length-1),l])},handleModalToggle:()=>a(void 0)}),e(ce,{variant:le.light,className:"pf-u-p-0",children:e(Ie,{isInline:!0,isExpanded:S,position:"left",children:e(Re,{panelContent:e(ke,{isResizable:!0,children:e(he,{children:e(He,{refresh:K,canViewDetails:m})})}),children:C(De,{children:[e(Ne,{content:t(S?"hide":"show"),children:e($,{"aria-label":t(S?"hide":"show"),variant:"plain",icon:S?e(Fe,{}):e(Je,{}),onClick:T})}),e(Ye,{}),e(Oe,{titleKey:p?n()?.name:"groups",subKey:p?"":"groupsDescription",helpUrl:p?"":Ee.groupsUrl,divider:!p,dropdownItems:p&&N?[e(_,{"data-testid":"renameGroupAction",onClick:()=>a(n()),children:t("renameGroup")},"renameGroup"),e(_,{"data-testid":"deleteGroup",onClick:G,children:t("deleteGroup")},"deleteGroup")]:void 0}),r.length>0&&C(Qe,{inset:{default:"insetNone",md:"insetSm",xl:"insetLg","2xl":"inset2xl"},activeKey:s,onSelect:(l,F)=>o(F),isBox:!0,mountOnEnter:!0,unmountOnExit:!0,children:[e(x,{"data-testid":"groups",eventKey:0,title:e(U,{children:t("childGroups")}),children:e(ne,{refresh:K})}),v&&e(x,{"data-testid":"members",eventKey:1,title:e(U,{children:t("members")}),children:e(nt,{})}),e(x,{"data-testid":"attributes",eventKey:2,title:e(U,{children:t("attributes")}),children:e(Ze,{})}),d&&e(x,{eventKey:3,"data-testid":"role-mapping-tab",title:e(U,{children:t("roleMapping")}),children:e(et,{id:p,name:n()?.name})}),O&&e(x,{eventKey:4,"data-testid":"permissionsTab",title:e(U,{children:t("permissions")}),children:e(Le,{id:p,type:"groups"})})]}),r.length===0&&e(ne,{refresh:K})]})})},I)})]})}export{Ot as default};
//# sourceMappingURL=GroupsSection-CqZh6Dcx.js.map
