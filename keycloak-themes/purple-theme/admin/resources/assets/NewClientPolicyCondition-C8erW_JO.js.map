{"version":3,"file":"NewClientPolicyCondition-C8erW_JO.js","sources":["../../src/realm-settings/NewClientPolicyCondition.tsx"],"sourcesContent":["import type { ConfigPropertyRepresentation } from \"@keycloak/keycloak-admin-client/lib/defs/authenticatorConfigInfoRepresentation\";\nimport type ClientPolicyConditionRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/clientPolicyConditionRepresentation\";\nimport type ClientPolicyRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/clientPolicyRepresentation\";\nimport type ComponentTypeRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/componentTypeRepresentation\";\nimport {\n  ActionGroup,\n  AlertVariant,\n  Button,\n  FormGroup,\n  PageSection,\n  Select,\n  SelectOption,\n  SelectVariant,\n} from \"@patternfly/react-core\";\nimport { camelCase } from \"lodash-es\";\nimport { useState } from \"react\";\nimport { Controller, FormProvider, useForm } from \"react-hook-form\";\nimport { useTranslation } from \"react-i18next\";\nimport { useNavigate, useParams } from \"react-router-dom\";\nimport { FormPanel, HelpItem } from \"ui-shared\";\nimport { adminClient } from \"../admin-client\";\nimport { useAlerts } from \"../components/alert/Alerts\";\nimport { DynamicComponents } from \"../components/dynamic/DynamicComponents\";\nimport { FormAccess } from \"../components/form/FormAccess\";\nimport { useRealm } from \"../context/realm-context/RealmContext\";\nimport { useServerInfo } from \"../context/server-info/ServerInfoProvider\";\nimport { useFetch } from \"../utils/useFetch\";\nimport { toEditClientPolicy } from \"./routes/EditClientPolicy\";\nimport type { EditClientPolicyConditionParams } from \"./routes/EditCondition\";\n\nexport type ItemType = { value: string };\n\ntype ConfigProperty = ConfigPropertyRepresentation & {\n  conditions: any;\n  config: any;\n};\n\nexport default function NewClientPolicyCondition() {\n  const { t } = useTranslation();\n  const { addAlert, addError } = useAlerts();\n  const navigate = useNavigate();\n  const { realm } = useRealm();\n\n  const [openConditionType, setOpenConditionType] = useState(false);\n  const [policies, setPolicies] = useState<ClientPolicyRepresentation[]>([]);\n\n  const [condition, setCondition] = useState<\n    ClientPolicyConditionRepresentation[]\n  >([]);\n  const [conditionData, setConditionData] =\n    useState<ClientPolicyConditionRepresentation>();\n  const [conditionType, setConditionType] = useState(\"\");\n  const [conditionProperties, setConditionProperties] = useState<\n    ConfigPropertyRepresentation[]\n  >([]);\n\n  const { policyName, conditionName } =\n    useParams<EditClientPolicyConditionParams>();\n\n  const serverInfo = useServerInfo();\n  const form = useForm<ConfigProperty>();\n\n  const conditionTypes =\n    serverInfo.componentTypes?.[\n      \"org.keycloak.services.clientpolicy.condition.ClientPolicyConditionProvider\"\n    ];\n\n  const setupForm = (condition: ClientPolicyConditionRepresentation) => {\n    form.reset({ config: condition.configuration || {} });\n  };\n\n  useFetch(\n    () => adminClient.clientPolicies.listPolicies(),\n\n    (policies) => {\n      setPolicies(policies.policies ?? []);\n\n      if (conditionName) {\n        const currentPolicy = policies.policies?.find(\n          (item) => item.name === policyName,\n        );\n\n        const typeAndConfigData = currentPolicy?.conditions?.find(\n          (item) => item.condition === conditionName,\n        );\n\n        const currentCondition = conditionTypes?.find(\n          (condition) => condition.id === conditionName,\n        );\n\n        setConditionData(typeAndConfigData!);\n        setConditionProperties(currentCondition?.properties!);\n        setupForm(typeAndConfigData!);\n      }\n    },\n    [],\n  );\n\n  const save = async (configPolicy: ConfigProperty) => {\n    const configValues = configPolicy.config;\n\n    const writeConfig = () => {\n      return conditionProperties.reduce((r: any, p) => {\n        r[p.name!] = configValues[p.name!];\n        return r;\n      }, {});\n    };\n\n    const updatedPolicies = policies.map((policy) => {\n      if (policy.name !== policyName) {\n        return policy;\n      }\n\n      let conditions = policy.conditions ?? [];\n\n      if (conditionName) {\n        const createdCondition = {\n          condition: conditionData?.condition,\n          configuration: writeConfig(),\n        };\n\n        const index = conditions.findIndex(\n          (condition) => conditionName === condition.condition,\n        );\n\n        if (index === -1) {\n          return;\n        }\n\n        const newConditions = [\n          ...conditions.slice(0, index),\n          createdCondition,\n          ...conditions.slice(index + 1),\n        ];\n\n        return {\n          ...policy,\n          conditions: newConditions,\n        };\n      }\n\n      conditions = conditions.concat({\n        condition: condition[0].condition,\n        configuration: writeConfig(),\n      });\n\n      return {\n        ...policy,\n        conditions,\n      };\n    }) as ClientPolicyRepresentation[];\n\n    try {\n      await adminClient.clientPolicies.updatePolicy({\n        policies: updatedPolicies,\n      });\n      setPolicies(updatedPolicies);\n      navigate(toEditClientPolicy({ realm, policyName: policyName! }));\n      addAlert(\n        conditionName\n          ? t(\"updateClientConditionSuccess\")\n          : t(\"createClientConditionSuccess\"),\n        AlertVariant.success,\n      );\n    } catch (error) {\n      addError(\"createClientConditionError\", error);\n    }\n  };\n\n  return (\n    <PageSection variant=\"light\">\n      <FormPanel\n        className=\"kc-login-screen\"\n        title={conditionName ? t(\"editCondition\") : t(\"addCondition\")}\n      >\n        <FormAccess\n          isHorizontal\n          role=\"manage-realm\"\n          className=\"pf-u-mt-lg\"\n          onSubmit={form.handleSubmit(save)}\n        >\n          <FormGroup\n            label={t(\"conditionType\")}\n            fieldId=\"conditionType\"\n            labelIcon={\n              <HelpItem\n                helpText={\n                  conditionType\n                    ? `${camelCase(conditionType.replace(/-/g, \" \"))}Help`\n                    : \"conditionsHelp\"\n                }\n                fieldLabelId=\"conditionType\"\n              />\n            }\n          >\n            <Controller\n              name=\"conditions\"\n              defaultValue={\"any-client\"}\n              control={form.control}\n              render={({ field }) => (\n                <Select\n                  placeholderText={t(\"selectACondition\")}\n                  className=\"kc-conditionType-select\"\n                  data-testid=\"conditionType-select\"\n                  toggleId=\"provider\"\n                  isDisabled={!!conditionName}\n                  onToggle={(toggle) => setOpenConditionType(toggle)}\n                  onSelect={(_, value) => {\n                    field.onChange(value);\n                    setConditionProperties(\n                      (value as ComponentTypeRepresentation).properties,\n                    );\n                    setConditionType((value as ComponentTypeRepresentation).id);\n                    setCondition([\n                      {\n                        condition: (value as ComponentTypeRepresentation).id,\n                      },\n                    ]);\n                    setOpenConditionType(false);\n                  }}\n                  selections={conditionName ? conditionName : conditionType}\n                  variant={SelectVariant.single}\n                  aria-label={t(\"conditionType\")}\n                  isOpen={openConditionType}\n                >\n                  {conditionTypes?.map((condition) => (\n                    <SelectOption\n                      selected={condition.id === field.value}\n                      description={t(\n                        camelCase(condition.id.replace(/-/g, \" \")),\n                      )}\n                      key={condition.id}\n                      value={condition}\n                    >\n                      {condition.id}\n                    </SelectOption>\n                  ))}\n                </Select>\n              )}\n            />\n          </FormGroup>\n\n          <FormProvider {...form}>\n            <DynamicComponents properties={conditionProperties} />\n          </FormProvider>\n          <ActionGroup>\n            <Button\n              variant=\"primary\"\n              type=\"submit\"\n              data-testid=\"addCondition-saveBtn\"\n              isDisabled={conditionType === \"\" && !conditionName}\n            >\n              {conditionName ? t(\"save\") : t(\"add\")}\n            </Button>\n            <Button\n              variant=\"link\"\n              data-testid=\"addCondition-cancelBtn\"\n              onClick={() =>\n                navigate(toEditClientPolicy({ realm, policyName: policyName! }))\n              }\n            >\n              {t(\"cancel\")}\n            </Button>\n          </ActionGroup>\n        </FormAccess>\n      </FormPanel>\n    </PageSection>\n  );\n}\n"],"names":["NewClientPolicyCondition","useTranslation","addAlert","addError","useAlerts","navigate","useNavigate","realm","useRealm","openConditionType","setOpenConditionType","useState","policies","setPolicies","condition","setCondition","conditionData","setConditionData","conditionType","setConditionType","conditionProperties","setConditionProperties","policyName","conditionName","useParams","serverInfo","useServerInfo","form","useForm","conditionTypes","setupForm","useFetch","adminClient","typeAndConfigData","item","currentCondition","save","configPolicy","configValues","writeConfig","r","p","updatedPolicies","policy","conditions","createdCondition","index","newConditions","toEditClientPolicy","AlertVariant","error","jsx","PageSection","FormPanel","jsxs","FormAccess","FormGroup","HelpItem","camelCase","Controller","field","Select","toggle","_","value","SelectVariant","SelectOption","FormProvider","DynamicComponents","ActionGroup","Button"],"mappings":"22CAqCA,SAAwBA,IAA2B,CAC3C,KAAA,CAAE,GAAMC,IACR,CAAE,SAAAC,EAAU,SAAAC,CAAS,EAAIC,EAAU,EACnCC,EAAWC,IACX,CAAE,MAAAC,GAAUC,IAEZ,CAACC,EAAmBC,CAAoB,EAAIC,EAAS,EAAK,EAC1D,CAACC,EAAUC,CAAW,EAAIF,EAAuC,CAAE,CAAA,EAEnE,CAACG,EAAWC,CAAY,EAAIJ,EAEhC,CAAE,CAAA,EACE,CAACK,EAAeC,CAAgB,EACpCN,EAA8C,EAC1C,CAACO,EAAeC,CAAgB,EAAIR,EAAS,EAAE,EAC/C,CAACS,EAAqBC,CAAsB,EAAIV,EAEpD,CAAE,CAAA,EAEE,CAAE,WAAAW,EAAY,cAAAC,CAAc,EAChCC,EAA2C,EAEvCC,EAAaC,IACbC,EAAOC,IAEPC,EACJJ,EAAW,iBACT,4EACF,EAEIK,EAAahB,GAAmD,CACpEa,EAAK,MAAM,CAAE,OAAQb,EAAU,eAAiB,GAAI,CAAA,EAGtDiB,EACE,IAAMC,EAAY,eAAe,aAAa,EAE7CpB,GAAa,CAGZ,GAFYA,EAAAA,EAAS,UAAY,CAAA,CAAE,EAE/BW,EAAe,CAKX,MAAAU,EAJgBrB,EAAS,UAAU,KACtCsB,GAASA,EAAK,OAASZ,CAAA,GAGe,YAAY,KAClDY,GAASA,EAAK,YAAcX,CAAA,EAGzBY,EAAmBN,GAAgB,KACtCf,GAAcA,EAAU,KAAOS,CAAA,EAGlCN,EAAiBgB,CAAkB,EACnCZ,EAAuBc,GAAkB,UAAW,EACpDL,EAAUG,CAAkB,CAC9B,CACF,EACA,CAAC,CAAA,EAGG,MAAAG,EAAO,MAAOC,GAAiC,CACnD,MAAMC,EAAeD,EAAa,OAE5BE,EAAc,IACXnB,EAAoB,OAAO,CAACoB,EAAQC,KACzCD,EAAEC,EAAE,IAAK,EAAIH,EAAaG,EAAE,IAAK,EAC1BD,GACN,CAAE,CAAA,EAGDE,EAAkB9B,EAAS,IAAK+B,GAAW,CAC3C,GAAAA,EAAO,OAASrB,EACX,OAAAqB,EAGL,IAAAC,EAAaD,EAAO,YAAc,GAEtC,GAAIpB,EAAe,CACjB,MAAMsB,EAAmB,CACvB,UAAW7B,GAAe,UAC1B,cAAeuB,EAAY,CAAA,EAGvBO,EAAQF,EAAW,UACtB9B,GAAcS,IAAkBT,EAAU,SAAA,EAG7C,GAAIgC,IAAU,GACZ,OAGF,MAAMC,EAAgB,CACpB,GAAGH,EAAW,MAAM,EAAGE,CAAK,EAC5BD,EACA,GAAGD,EAAW,MAAME,EAAQ,CAAC,CAAA,EAGxB,MAAA,CACL,GAAGH,EACH,WAAYI,CAAA,CAEhB,CAEA,OAAAH,EAAaA,EAAW,OAAO,CAC7B,UAAW9B,EAAU,CAAC,EAAE,UACxB,cAAeyB,EAAY,CAAA,CAC5B,EAEM,CACL,GAAGI,EACH,WAAAC,CAAA,CACF,CACD,EAEG,GAAA,CACI,MAAAZ,EAAY,eAAe,aAAa,CAC5C,SAAUU,CAAA,CACX,EACD7B,EAAY6B,CAAe,EAC3BrC,EAAS2C,EAAmB,CAAE,MAAAzC,EAAO,WAAAe,CAAA,CAAyB,CAAC,EAC/DpB,EAEM,EADJqB,EACM,+BACA,8BAD8B,EAEpC0B,GAAa,OAAA,QAERC,EAAO,CACd/C,EAAS,6BAA8B+C,CAAK,CAC9C,CAAA,EAIA,OAAAC,EAACC,EAAY,CAAA,QAAQ,QACnB,SAAAD,EAACE,EAAA,CACC,UAAU,kBACV,MAAuB,EAAhB9B,EAAkB,gBAAqB,cAAN,EAExC,SAAA+B,EAACC,GAAA,CACC,aAAY,GACZ,KAAK,eACL,UAAU,aACV,SAAU5B,EAAK,aAAaS,CAAI,EAEhC,SAAA,CAAAe,EAACK,EAAA,CACC,MAAO,EAAE,eAAe,EACxB,QAAQ,gBACR,UACEL,EAACM,EAAA,CACC,SACEvC,EACI,GAAGwC,EAAUxC,EAAc,QAAQ,KAAM,GAAG,CAAC,CAAC,OAC9C,iBAEN,aAAa,eAAA,CACf,EAGF,SAAAiC,EAACQ,EAAA,CACC,KAAK,aACL,aAAc,aACd,QAAShC,EAAK,QACd,OAAQ,CAAC,CAAE,MAAAiC,CAAA,IACTT,EAACU,GAAA,CACC,gBAAiB,EAAE,kBAAkB,EACrC,UAAU,0BACV,cAAY,uBACZ,SAAS,WACT,WAAY,CAAC,CAACtC,EACd,SAAWuC,GAAWpD,EAAqBoD,CAAM,EACjD,SAAU,CAACC,EAAGC,IAAU,CACtBJ,EAAM,SAASI,CAAK,EACpB3C,EACG2C,EAAsC,UAAA,EAEzC7C,EAAkB6C,EAAsC,EAAE,EAC7CjD,EAAA,CACX,CACE,UAAYiD,EAAsC,EACpD,CAAA,CACD,EACDtD,EAAqB,EAAK,CAC5B,EACA,WAAYa,GAAgCL,EAC5C,QAAS+C,GAAc,OACvB,aAAY,EAAE,eAAe,EAC7B,OAAQxD,EAEP,SAAAoB,GAAgB,IAAKf,GACpBqC,EAACe,GAAA,CACC,SAAUpD,EAAU,KAAO8C,EAAM,MACjC,YAAa,EACXF,EAAU5C,EAAU,GAAG,QAAQ,KAAM,GAAG,CAAC,CAC3C,EAEA,MAAOA,EAEN,SAAAA,EAAU,EAAA,EAHNA,EAAU,EAAA,CAKlB,CAAA,CACH,CAAA,CAEJ,CAAA,CACF,EAEAqC,EAACgB,IAAc,GAAGxC,EAChB,WAACyC,GAAkB,CAAA,WAAYhD,EAAqB,CACtD,CAAA,IACCiD,GACC,CAAA,SAAA,CAAAlB,EAACmB,EAAA,CACC,QAAQ,UACR,KAAK,SACL,cAAY,uBACZ,WAAYpD,IAAkB,IAAM,CAACK,EAEpC,SAAgB,EAAAA,EAAE,OAAY,KAAN,CAAW,CACtC,EACA4B,EAACmB,EAAA,CACC,QAAQ,OACR,cAAY,yBACZ,QAAS,IACPjE,EAAS2C,EAAmB,CAAE,MAAAzC,EAAO,WAAAe,CAAA,CAAyB,CAAC,EAGhE,WAAE,QAAQ,CAAA,CACb,CAAA,EACF,CAAA,CAAA,CACF,CAAA,CAEJ,CAAA,CAAA,CAEJ"}