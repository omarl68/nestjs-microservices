import{jsx as e,jsxs as o,Fragment as A}from"react/jsx-runtime";import{V as ge}from"./ViewHeader-cxZm8XhN.js";import{u as E,O as me,Q as ye,D as Q,e as de,g as ke,ed as ve,Y as W,G as q,H as M,an as Ae,aX as ue,h as w,cd as Te,B as J,A as G,I as Ue,J as Se,S as Ce,bH as Ne,aR as he,aq as De,b as X,c as Fe,q as Ie,f as L,U as Ke,ar as z,L as we,be as Ee,n as se,bd as Pe,K as Ve,cE as xe,ee as Re,a6 as Oe,a7 as Le,ag as Be,P as _e,dk as ne}from"./index-C9t2UlUN.js";import{P as qe}from"./PermissionTab-Cqx0kVF9.js";import{useState as b}from"react";import{u as oe}from"./ConfirmDialog-BDkqxnFL.js";import{S as Ge,A as je,L as He}from"./PaginatingTableToolbar-oQUfBy2J.js";import{a as $e}from"./AddRoleMappingModal-BWNuJU0W.js";import{a1 as Me}from"./KeycloakDataTable-2rLFZPhG.js";import{F as Qe}from"./filter-icon-C8nM2k1N.js";import{K as ie}from"./KeycloakTextInput-DrlF32nr.js";import{A as We}from"./Form-Cdw1qhWG.js";import{D as ze}from"./DropdownPanel-UFbgzvY8.js";import{b as K,T as Je,a as Xe}from"./ToolbarContent-D6TJq6fk.js";import{E as Ye}from"./EmptyStateBody-CyIhnUop.js";import{W as Ze}from"./warning-triangle-icon-BwpfST2i.js";import{a as et}from"./FlexItem-BEayPdRt.js";import{R as tt,u as rt}from"./RoutableTabs-vx5wTdby.js";import{u as at,F as st}from"./useIsFeatureEnabled-CkHhuO9z.js";/* empty css                     */import{a as le,b as ce}from"./Tabs-CjrDEqsl.js";import"react-dom";import"./Trans-DcN6j3pV.js";import"./Modal-Bgkd26UL.js";import"./EmptyStateSecondaryActions-BekVwNvY.js";import"./grip-vertical-icon-B_ub3hpF.js";import"./_baseFlatten-BQ8y46Zj.js";import"./PageHandler-TK8xnd8P.js";import"./DynamicComponents-D5DD9CFr.js";import"./FileUpload-CTw4RKK1.js";import"./CodeEditor-Cp4g17EF.js";import"./copy-icon-CYSS18Ce.js";import"./GroupPickerDialog-tI6XV7Ln.js";import"./useToggle-K3Kx99tM.js";import"./DataListItemRow-Bimi62Tu.js";import"./KeySelect-CPI9XGq0.js";import"./MultiLineInput-DibC-IV_.js";import"./PasswordInput-CJKuHljf.js";import"./KeycloakTextArea-DChmurIP.js";import"./PageList-59HC89eh.js";import"./MenuList-Br-Zu33q.js";const nt=({searchType:t,onSelect:n})=>{const{t:m}=E(),[g,f]=b(!1),a=c=>e(Q,{onClick:()=>{n(c),f(!1)},children:m(`searchType.${c}`)},c),y=[a("default"),a("attribute")];return e(me,{className:"keycloak__users__searchtype",toggle:o(ye,{id:"toggle-id",onToggle:f,children:[e(Qe,{})," ",m(`searchType.${t}`)]}),isOpen:g,dropdownItems:y})};function ot({activeFilters:t,setActiveFilters:n,profile:m,createAttributeSearchChips:g,searchUserWithAttributes:f}){const{t:a}=E(),{addAlert:y}=de(),[c,k]=b(!1),T={name:"",displayName:"",value:""},{getValues:u,register:v,reset:U,formState:{errors:h},setValue:P,setError:S,clearErrors:O}=ke({mode:"onChange",defaultValues:T}),p=()=>t.some(s=>s.name===u().name),i=()=>{let s=!1;return u().name.length?t.some(l=>l.name===u().name)?S("name",{type:"conflict",message:a("searchUserByAttributeKeyAlreadyInUseError")}):s=!0:S("name",{type:"empty",message:a("searchUserByAttributeMissingKeyError")}),s},V=()=>{let s=!1;return u().value.length?s=!0:S("value",{type:"empty",message:a("searchUserByAttributeMissingValueError")}),s},D=()=>i()&&V(),F=()=>{D()?(n([...t,{...u()}]),U()):(h.name?.message&&y(h.name.message,G.danger),h.value?.message&&y(h.value.message,G.danger))},I=()=>{const s=[...t].filter(l=>l.name!==l.name);n(s)},x=()=>m?e(Ue,{"data-testid":"search-attribute-name",variant:Se.typeahead,onToggle:s=>k(s),selections:u().displayName,onSelect:(s,l)=>{P("displayName",l.toString()),p()?S("name",{type:"conflict"}):O("name")},isOpen:c,placeholderText:a("selectAttribute"),validated:h.name&&"error",maxHeight:300,...v("displayName",{required:!0,validate:i}),children:m.attributes?.map(s=>e(Ce,{value:Ne(a,s.displayName,s.name),onClick:l=>{l.stopPropagation(),k(!1),P("name",s.name)}},s.name))}):e(ie,{id:"name",placeholder:a("keyPlaceholder"),validated:h.name&&"error",onKeyDown:s=>s.key==="Enter"&&F(),...v("name",{required:!0,validate:i})});return o(ve,{className:"user-attribute-search-form",children:[e(W,{className:"user-attribute-search-form-headline",children:e(q,{component:M.h2,children:a("selectAttributes")})}),e(Ae,{isInline:!0,className:"user-attribute-search-form-alert",variant:"info",title:a("searchUserByAttributeDescription"),component:"h3"}),o(W,{className:"user-attribute-search-form-key-value",children:[e("div",{className:"user-attribute-search-form-left",children:e(q,{component:M.h3,children:a("key")})}),e("div",{className:"user-attribute-search-form-right",children:e(q,{component:M.h3,children:a("value")})})]}),e("div",{className:"user-attribute-search-form-left",children:x()}),e("div",{className:"user-attribute-search-form-right",children:o(ue,{children:[e(ie,{id:"value",placeholder:a("valuePlaceholder"),validated:h.value&&"error",onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),F())},...v("value",{required:!0,validate:V})}),e(w,{variant:"control",icon:e(Te,{}),onClick:F,"aria-label":a("addToFilter")})]})}),g(),o(We,{className:"user-attribute-search-form-action-group",children:[e(w,{"data-testid":"search-user-attribute-btn",variant:"primary",type:"submit",isDisabled:!t.length,onClick:f,children:a("search")}),e(w,{variant:J.link,onClick:()=>{U(),I()},children:a("reset")})]})]})}function it({searchDropdownOpen:t,setSearchDropdownOpen:n,realm:m,hasSelectedRows:g,toggleDeleteDialog:f,toggleUnlockUsersDialog:a,goToCreate:y,searchType:c,setSearchType:k,searchUser:T,setSearchUser:u,activeFilters:v,setActiveFilters:U,refresh:h,profile:P,clearAllFilters:S,createAttributeSearchChips:O,searchUserWithAttributes:p}){const{t:i}=E(),[V,D]=b(!1),{hasAccess:F}=he(),I=F("query-users"),x=()=>e(K,{children:o(ue,{children:[e(nt,{searchType:c,onSelect:C=>{S(),k(C)}}),c==="default"&&s(),c==="attribute"&&l()]})}),s=()=>e(K,{children:e(Ge,{placeholder:i("searchForUser"),"aria-label":i("search"),value:T,onChange:(C,B)=>{u(B)},onSearch:()=>{u(T),h()},onKeyDown:C=>{C.key==="Enter"&&(u(T),h())},onClear:()=>{u(""),h()}})}),l=()=>o(A,{children:[e(ze,{buttonText:i("selectAttributes"),setSearchDropdownOpen:n,searchDropdownOpen:t,width:"15vw",children:e(ot,{activeFilters:v,setActiveFilters:U,profile:P,createAttributeSearchChips:O,searchUserWithAttributes:()=>{p(),n(!1)}})}),e(w,{icon:e(je,{}),variant:"control",onClick:()=>{p(),n(!1)},"aria-label":i("searchAttributes")})]}),j=m.bruteForceProtected?e(K,{children:e(me,{toggle:e(De,{onToggle:C=>D(C)}),isOpen:V,isPlain:!0,dropdownItems:[e(Q,{component:"button",isDisabled:g,onClick:()=>{f(),D(!1)},children:i("deleteUser")},"deleteUser"),e(Q,{component:"button",onClick:()=>{a(),D(!1)},children:i("unlockAllUsers")},"unlock")]})}):e(K,{children:e(w,{variant:J.link,onClick:f,"data-testid":"delete-user-btn",isDisabled:g,children:i("deleteUser")})}),H=o(A,{children:[e(K,{children:e(w,{"data-testid":"add-user",onClick:y,children:i("addUser")})}),j]});return o(A,{children:[x(),I?H:null]})}const lt=t=>{const{realm:n}=X();return o(we,{to:Ee({realm:n,id:t.id,tab:"settings"}),children:[t.username," ",e(ct,{user:t})]})},ct=({user:t})=>{const{t:n}=E();return o(A,{children:[!t.enabled&&e(se,{color:"red",icon:e(Pe,{}),children:n("disabled")}),t.bruteForceStatus?.disabled&&e(se,{color:"orange",icon:e(Ze,{}),children:n("temporaryLocked")})]})},mt=t=>{const{t:n}=E();return o(A,{children:[!t.emailVerified&&e(Ve,{content:n("notVerified"),children:e(xe,{className:"keycloak__user-section__email-verified"})})," ",z()(t.email)]})};function dt(){const{t}=E(),{addAlert:n,addError:m}=de(),{realm:g}=X(),f=Fe(),[a,y]=b(),[c,k]=b(""),[T,u]=b(),[v,U]=b([]),[h,P]=b("default"),[S,O]=b(!1),[p,i]=b([]),[V,D]=b({}),[F,I]=b(""),[x,s]=b(0),l=()=>s(x+1);Ie(async()=>{const r={type:"org.keycloak.storage.UserStorageProvider"};try{return await Promise.all([L.components.find(r),L.realms.findOne({realm:g}),L.users.getProfile()])}catch{return[[],{},{}]}},([r,d,R])=>{y(r.filter(N=>N.config?.enabled?.[0]==="true")),u(d),D(R)},[]);const j=async(r,d,R)=>{const N={first:r,max:d,q:F},_=R||c||"";if(_&&(N.search=_),!Z&&!(N.search||N.q))return[];try{return await $e({briefRepresentation:!0,...N})}catch(ae){return a?.length?m("noUsersFoundErrorStorage",ae):m("noUsersFoundError",ae),[]}},[H,C]=oe({titleKey:"unlockAllUsers",messageKey:"unlockUsersConfirm",continueButtonLabel:"unlock",onConfirm:async()=>{try{await L.attackDetection.delAll(),l(),n(t("unlockUsersSuccess"),G.success)}catch(r){m("unlockUsersError",r)}}}),[B,pe]=oe({titleKey:"deleteConfirmUsers",messageKey:t("deleteConfirmDialog",{count:v.length}),continueButtonLabel:"delete",continueButtonVariant:J.danger,onConfirm:async()=>{try{for(const r of v)await L.users.del({id:r.id});U([]),$(),n(t("userDeletedSuccess"),G.success)}catch(r){m("userDeletedError",r)}}}),Y=()=>f(Re({realm:g}));if(!a||!T)return e(Ke,{});const Z=!(a.length>0),$=()=>{const r=[...p].filter(d=>d.name!==d.name);i(r),k(""),I(""),l()},ee=r=>r.map(d=>`${d.name}:${d.value}`).join(" "),be=()=>{const r=ee(p);I(r),l()},te=()=>e(et,{children:p.length>0&&e(A,{children:Object.values(p).map(r=>e(Oe,{className:"pf-u-mt-md pf-u-mr-md",categoryName:r.displayName.length?r.displayName:r.name,isClosable:!0,onClick:d=>{d.stopPropagation();const R=[...p].filter(_=>_.name!==r.name),N=ee(R);i(R),I(N),l()},children:e(Le,{isReadOnly:!0,children:r.value},r.name)},r.name))})}),re=()=>e(it,{searchDropdownOpen:S,setSearchDropdownOpen:O,realm:T,hasSelectedRows:v.length===0,toggleDeleteDialog:B,toggleUnlockUsersDialog:H,goToCreate:Y,searchType:h,setSearchType:P,searchUser:c,setSearchUser:k,activeFilters:p,setActiveFilters:i,refresh:l,profile:V,clearAllFilters:$,createAttributeSearchChips:te,searchUserWithAttributes:be}),fe=()=>{if(p.length)return o("div",{className:"user-attribute-search-form-subtoolbar",children:[e(K,{children:te()}),e(K,{children:e(w,{variant:"link",onClick:()=>{$()},children:t("clearAllFilters")})})]})};return o(A,{children:[e(pe,{}),e(C,{}),e(Me,{isSearching:c!==""||p.length!==0,loader:j,isPaginated:!0,ariaLabelKey:"titleUsers",canSelectAll:!0,onSelect:r=>U([...r]),emptyState:Z?e(He,{message:t("noUsersFound"),instructions:t("emptyInstructions"),primaryActionText:t("createNewUser"),onPrimaryAction:Y}):o(A,{children:[e(Je,{children:e(Xe,{children:re()})}),e(Ye,{"data-testid":"empty-state",variant:"large",children:e(W,{className:"kc-search-users-text",children:e(q,{children:t("searchForUserDescription")})})})]}),toolbarItem:re(),subToolbar:fe(),actionResolver:r=>{const d=r.data;return d.access?.manage?[{title:t("delete"),onClick:()=>{U([d]),B()}}]:[]},columns:[{name:"username",displayKey:"username",cellRenderer:lt},{name:"email",displayKey:"email",cellRenderer:mt},{name:"lastName",displayKey:"lastName",cellFormatters:[z()]},{name:"firstName",displayKey:"firstName",cellFormatters:[z()]}]},x)]})}function Zt(){const{t}=E(),{realm:n}=X(),{hasAccess:m}=he(),f=at()(st.AdminFineGrainedAuthz)&&m("manage-authorization","manage-users","manage-clients"),a=k=>rt(ne({realm:n,tab:k})),y=a("list"),c=a("permissions");return o(A,{children:[e(ge,{titleKey:"titleUsers",subKey:"usersExplain",helpUrl:Be.usersUrl,divider:!1}),e(_e,{"data-testid":"users-page",variant:"light",className:"pf-u-p-0",children:o(tt,{"data-testid":"user-tabs",defaultLocation:ne({realm:n,tab:"list"}),isBox:!0,mountOnEnter:!0,children:[e(le,{id:"list","data-testid":"listTab",title:e(ce,{children:t("userList")}),...y,children:e(dt,{})}),f&&e(le,{id:"permissions","data-testid":"permissionsTab",title:e(ce,{children:t("permissions")}),...c,children:e(qe,{type:"users"})})]})})]})}export{Zt as default};
//# sourceMappingURL=UsersSection-BDZa1IE6.js.map
